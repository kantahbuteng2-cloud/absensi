<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Absensi QR Code</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .header {
            background: linear-gradient(to right, #4a6fa5, #3b5998);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        /* Form Styles */
        .form-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }
        
        .form-group input {
            padding: 15px;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #4a6fa5;
        }
        
        .btn {
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #4a6fa5, #3b5998);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 111, 165, 0.4);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5eb;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        /* QR Scanner Page */
        #scanner-page {
            display: none;
        }
        
        .scanner-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        #reader {
            width: 100%;
            height: 300px;
            border: 3px solid #4a6fa5;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #4a6fa5;
        }
        
        .user-info h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .info-item {
            font-size: 0.9rem;
        }
        
        .info-item .label {
            font-weight: 600;
            color: #666;
        }
        
        .info-item .value {
            color: #333;
        }
        
        .scan-result {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
        
        .scan-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .scan-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .scan-result.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4a6fa5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Admin Link Styles */
        .admin-link {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }
        
        .admin-link a {
            color: #4a6fa5;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .admin-link a:hover {
            color: #3b5998;
            text-decoration: underline;
        }
        
        /* Info Box */
        .info-box {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #4a6fa5;
        }
        
        .info-box h4 {
            color: #2c5282;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .info-box p {
            color: #2d3748;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        /* Status Absensi */
        .status-container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .status-item {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            flex: 1;
            margin: 0 5px;
        }
        
        .status-item.active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-item.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Jam Kerja Info */
        .jam-info {
            background: #fff3cd;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }
        
        .jam-info h4 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .jam-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            #reader {
                height: 250px;
            }
            
            .info-grid, .jam-grid {
                grid-template-columns: 1fr;
            }
            
            .status-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .status-item {
                margin: 0;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 15px;
            margin-top: 20px;
            color: #666;
            font-size: 0.8rem;
            border-top: 1px solid #e1e5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login/Register Page -->
        <div id="login-page">
            <div class="header">
                <h1><i class="fas fa-qrcode"></i> ABSENSI QR CODE</h1>
                <p>Sistem Absensi Digital</p>
            </div>
            
            <div class="content">
                <div class="form-container">
                    <div class="info-box">
                        <h4><i class="fas fa-info-circle"></i> Informasi Sistem</h4>
                        <p>Masukkan NIP Anda untuk login. Jika perangkat baru, daftarkan terlebih dahulu.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="nip"><i class="fas fa-id-card"></i> NOMOR INDUK PEGAWAI (NIP)</label>
                        <input type="text" id="nip" placeholder="Masukkan NIP Anda" autocomplete="off">
                    </div>
                    
                    <button class="btn btn-primary" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> MASUK / LOGIN
                    </button>
                    
                    <div class="form-group">
                        <p style="text-align: center; color: #666; font-weight: 600;">ATAU</p>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="showRegister()">
                        <i class="fas fa-mobile-alt"></i> DAFTARKAN PERANGKAT BARU
                    </button>
                    
                    <!-- Admin Link untuk Generate QR Code -->
                    <div class="admin-link">
                        <a href="qr-generator.html" target="_blank">
                            <i class="fas fa-qrcode"></i> ADMIN: GENERATE QR CODE
                        </a>
                    </div>
                    
                    <!-- Informasi Jam Kerja -->
                    <div class="jam-info">
                        <h4><i class="fas fa-clock"></i> JAM ABSENSI</h4>
                        <div class="jam-grid">
                            <div>
                                <strong>Apel Pagi:</strong><br>
                                05:20 - 21:55
                            </div>
                            <div>
                                <strong>Apel Sore:</strong><br>
                                05:50 - 22:20
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p><i class="fas fa-database"></i> Sistem Terhubung ke Google Spreadsheet</p>
                        <p style="font-size: 0.7rem; margin-top: 5px;">Â© 2024 Sistem Absensi QR Code</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Register Page -->
        <div id="register-page" class="hidden">
            <div class="header">
                <h1><i class="fas fa-mobile-alt"></i> DAFTAR PERANGKAT BARU</h1>
                <p>Registrasi perangkat untuk pertama kali</p>
            </div>
            
            <div class="content">
                <div class="form-container">
                    <div class="info-box">
                        <h4><i class="fas fa-exclamation-triangle"></i> PERHATIAN</h4>
                        <p>Daftarkan perangkat ini hanya jika Anda belum pernah login sebelumnya. Setiap perangkat hanya bisa didaftarkan untuk satu NIP.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="reg-nip"><i class="fas fa-id-card"></i> NOMOR INDUK PEGAWAI (NIP)</label>
                        <input type="text" id="reg-nip" placeholder="Masukkan NIP Anda" autocomplete="off">
                    </div>
                    
                    <button class="btn btn-primary" onclick="registerDevice()">
                        <i class="fas fa-check-circle"></i> DAFTARKAN PERANGKAT INI
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showLogin()">
                        <i class="fas fa-arrow-left"></i> KEMBALI KE LOGIN
                    </button>
                    
                    <div class="footer">
                        <p>Pastikan NIP yang dimasukkan sudah terdaftar di database</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- QR Scanner Page -->
        <div id="scanner-page">
            <button class="logout-btn" onclick="logout()" title="Keluar / Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
            
            <div class="header">
                <h1><i class="fas fa-camera"></i> SCAN QR CODE</h1>
                <p id="current-time">--:--:--</p>
            </div>
            
            <div class="content">
                <div class="scanner-container">
                    <!-- Informasi Pengguna -->
                    <div class="user-info">
                        <h3><i class="fas fa-user-tie"></i> DATA PEGAWAI</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="label">NIP</div>
                                <div class="value" id="user-nip">-</div>
                            </div>
                            <div class="info-item">
                                <div class="label">NAMA LENGKAP</div>
                                <div class="value" id="user-name">-</div>
                            </div>
                            <div class="info-item">
                                <div class="label">JABATAN</div>
                                <div class="value" id="user-position">-</div>
                            </div>
                            <div class="info-item">
                                <div class="label">ID PERANGKAT</div>
                                <div class="value" id="user-device">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Absensi Hari Ini -->
                    <div id="status-absensi" class="status-container hidden">
                        <div class="status-item" id="status-pagi">
                            <div style="font-weight: 600; margin-bottom: 5px;">APEL PAGI</div>
                            <div id="waktu-pagi">-</div>
                        </div>
                        <div class="status-item" id="status-sore">
                            <div style="font-weight: 600; margin-bottom: 5px;">APEL SORE</div>
                            <div id="waktu-sore">-</div>
                        </div>
                    </div>
                    
                    <!-- Scanner Area -->
                    <div id="reader"></div>
                    
                    <!-- Petunjuk Scanner -->
                    <div class="info-box">
                        <h4><i class="fas fa-lightbulb"></i> PETUNJUK SCAN</h4>
                        <p>1. Arahkan kamera ke QR Code<br>
                        2. Pastikan QR Code berada dalam frame<br>
                        3. Tunggu hingga terdeteksi otomatis</p>
                    </div>
                    
                    <!-- Hasil Scan -->
                    <div id="scan-result" class="scan-result">
                        <h3 id="result-title"></h3>
                        <p id="result-message"></p>
                        <p id="result-time" style="margin-top: 10px; font-size: 0.9rem;"></p>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loading" class="loading">
                        <div class="loading-spinner"></div>
                        <p>Memproses absensi...</p>
                    </div>
                    
                    <!-- Tombol Manual (Fallback) -->
                    <div style="margin-top: 20px; display: none;" id="manual-buttons">
                        <p style="text-align: center; margin-bottom: 10px; color: #666;">Jika scanner tidak bekerja:</p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" style="flex: 1;" onclick="manualAbsen('APEL_PAGI')">
                                <i class="fas fa-sun"></i> ABSEN PAGI
                            </button>
                            <button class="btn btn-secondary" style="flex: 1;" onclick="manualAbsen('APEL_SORE')">
                                <i class="fas fa-moon"></i> ABSEN SORE
                            </button>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p id="device-info">Perangkat: -</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        // Konfigurasi GAS
        const SCRIPT_ID = '1yCNScPfWNGwxoHpCpqIfDyIv7W-xjj0r6V2G7lwOEMs';
        const GAS_URL = `https://script.google.com/macros/s/${SCRIPT_ID}/exec`;
        
        // State aplikasi
        let currentUser = null;
        let currentDeviceId = null;
        let scanner = null;
        let todayAbsensi = { pagi: null, sore: null };
        
        // Generate Device ID
        function generateDeviceId() {
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substr(2, 9);
            return `DEV-${timestamp}-${randomStr}`.toUpperCase();
        }
        
        // Update waktu real-time
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const dateString = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.innerHTML = `${dateString}<br><strong>${timeString}</strong>`;
            }
        }
        
        // Navigasi antar halaman
        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('scanner-page').classList.add('hidden');
            document.getElementById('nip').focus();
        }
        
        function showRegister() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.remove('hidden');
            document.getElementById('scanner-page').classList.add('hidden');
            document.getElementById('reg-nip').focus();
        }
        
        function showScanner() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('scanner-page').classList.remove('hidden');
            updateUserInfo();
            loadTodayAbsensi();
        }
        
        // Login dengan NIP
        async function login() {
            const nip = document.getElementById('nip').value.trim();
            
            if (!nip) {
                alert('Silakan masukkan NIP');
                return;
            }
            
            if (nip.length < 3) {
                alert('NIP terlalu pendek');
                return;
            }
            
            try {
                showLoading(true);
                
                // Cek apakah device sudah terdaftar
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'login',
                        nip: nip
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    currentDeviceId = result.deviceId;
                    
                    // Simpan ke localStorage
                    localStorage.setItem('absensi_user', JSON.stringify(currentUser));
                    localStorage.setItem('absensi_device', currentDeviceId);
                    localStorage.setItem('absensi_last_login', new Date().toISOString());
                    
                    // Update info device di footer
                    document.getElementById('device-info').textContent = 
                        `Perangkat: ${currentDeviceId.substring(0, 15)}...`;
                    
                    // Inisialisasi QR Scanner
                    initQRScanner();
                    showScanner();
                    
                    // Beri feedback sukses
                    showToast('Login berhasil!', 'success');
                } else {
                    alert(result.message || 'NIP tidak ditemukan atau device belum terdaftar');
                    showRegister(); // Arahkan ke pendaftaran
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Terjadi kesalahan saat login. Periksa koneksi internet Anda.');
            } finally {
                showLoading(false);
            }
        }
        
        // Daftar device baru
        async function registerDevice() {
            const nip = document.getElementById('reg-nip').value.trim();
            
            if (!nip) {
                alert('Silakan masukkan NIP');
                return;
            }
            
            if (nip.length < 3) {
                alert('NIP terlalu pendek');
                return;
            }
            
            try {
                showLoading(true);
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'register',
                        nip: nip
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Device berhasil didaftarkan!\n\nDevice ID: ${result.deviceId}\n\nSilakan login dengan NIP Anda.`);
                    showLogin();
                    document.getElementById('nip').value = nip;
                    document.getElementById('nip').focus();
                } else {
                    alert(result.message || 'Gagal mendaftarkan device');
                }
            } catch (error) {
                console.error('Register error:', error);
                alert('Terjadi kesalahan saat pendaftaran. Periksa koneksi internet Anda.');
            } finally {
                showLoading(false);
            }
        }
        
        // Inisialisasi QR Scanner
        function initQRScanner() {
            if (scanner) {
                scanner.clear();
                scanner = null;
            }
            
            const readerDiv = document.getElementById('reader');
            readerDiv.innerHTML = '';
            
            scanner = new Html5Qrcode("reader");
            
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                scanner.pause();
                processQRScan(decodedText);
            };
            
            const qrCodeErrorCallback = (error) => {
                // Error handling di sini
                console.log("QR Scan error:", error);
            };
            
            const config = { 
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                }
            };
            
            scanner.start(
                { facingMode: "environment" },
                config,
                qrCodeSuccessCallback,
                qrCodeErrorCallback
            ).then(() => {
                console.log("QR Scanner started successfully");
                // Sembunyikan tombol manual
                document.getElementById('manual-buttons').style.display = 'none';
            }).catch(err => {
                console.error("QR Scanner error:", err);
                
                // Tampilkan tombol manual sebagai fallback
                document.getElementById('manual-buttons').style.display = 'block';
                
                if (err.name === 'NotAllowedError') {
                    alert("Izin kamera ditolak. Silakan izinkan akses kamera di pengaturan browser.");
                } else if (err.name === 'NotFoundError') {
                    alert("Kamera tidak ditemukan. Pastikan perangkat memiliki kamera.");
                } else {
                    alert("Tidak dapat mengakses kamera: " + err.message);
                }
            });
        }
        
        // Proses hasil scan QR
        async function processQRScan(qrData) {
            const resultDiv = document.getElementById('scan-result');
            const resultTitle = document.getElementById('result-title');
            const resultMessage = document.getElementById('result-message');
            const resultTime = document.getElementById('result-time');
            
            try {
                showLoading(true);
                resultDiv.classList.add('hidden');
                
                // Validasi format QR
                if (!qrData.includes('APEL_')) {
                    showResult('error', 'QR Code Tidak Valid', 'Format QR Code tidak dikenali. Gunakan QR Code absensi resmi.');
                    setTimeout(() => {
                        if (scanner) scanner.resume();
                    }, 3000);
                    return;
                }
                
                const absenType = qrData; // APEL_PAGI atau APEL_SORE
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const time = now.toTimeString().split(' ')[0];
                
                // Tampilkan informasi scan
                const jenis = absenType === 'APEL_PAGI' ? 'PAGI' : 'SORE';
                console.log(`Scan berhasil: ${jenis} - ${time}`);
                
                // Kirim data absensi ke GAS
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'absen',
                        nip: currentUser.nip,
                        nama: currentUser.nama,
                        tanggal: today,
                        waktu: time,
                        jenis_absen: absenType,
                        device_id: currentDeviceId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('success', `Absensi ${jenis} Berhasil`, result.message);
                    resultTime.textContent = `Waktu: ${time}`;
                    
                    // Update status absensi
                    if (absenType === 'APEL_PAGI') {
                        todayAbsensi.pagi = time;
                        document.getElementById('status-pagi').classList.add('active');
                        document.getElementById('waktu-pagi').textContent = time;
                    } else {
                        todayAbsensi.sore = time;
                        document.getElementById('status-sore').classList.add('active');
                        document.getElementById('waktu-sore').textContent = time;
                    }
                    
                    // Play success sound (jika diizinkan browser)
                    playBeepSound('success');
                    
                } else {
                    showResult(result.type || 'error', `Absensi ${jenis} Gagal`, result.message);
                    resultTime.textContent = `Waktu: ${time}`;
                    playBeepSound('error');
                }
                
            } catch (error) {
                console.error('Absen error:', error);
                showResult('error', 'Kesalahan Sistem', 'Terjadi kesalahan saat memproses absensi. Periksa koneksi internet.');
                playBeepSound('error');
            } finally {
                showLoading(false);
                setTimeout(() => {
                    resultDiv.classList.add('hidden');
                    if (scanner) {
                        scanner.resume();
                    }
                }, 3000);
            }
        }
        
        // Tampilkan hasil scan
        function showResult(type, title, message) {
            const resultDiv = document.getElementById('scan-result');
            const resultTitle = document.getElementById('result-title');
            const resultMessage = document.getElementById('result-message');
            
            resultDiv.className = `scan-result ${type}`;
            resultTitle.textContent = title;
            resultMessage.textContent = message;
            resultDiv.classList.remove('hidden');
            
            // Scroll ke hasil
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Update info pengguna
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('user-nip').textContent = currentUser.nip || '-';
                document.getElementById('user-name').textContent = currentUser.nama || '-';
                document.getElementById('user-position').textContent = currentUser.jabatan || '-';
                document.getElementById('user-device').textContent = 
                    currentDeviceId ? currentDeviceId.substring(0, 20) + '...' : '-';
                
                // Tampilkan container status
                document.getElementById('status-absensi').classList.remove('hidden');
            }
        }
        
        // Load absensi hari ini
        async function loadTodayAbsensi() {
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // In a real implementation, you would fetch this from GAS
                // For now, we'll just initialize
                todayAbsensi = { pagi: null, sore: null };
                
                // Reset status display
                document.getElementById('status-pagi').className = 'status-item';
                document.getElementById('status-sore').className = 'status-item';
                document.getElementById('waktu-pagi').textContent = '-';
                document.getElementById('waktu-sore').textContent = '-';
                
            } catch (error) {
                console.error('Error loading absensi:', error);
            }
        }
        
        // Manual absen (fallback)
        function manualAbsen(jenis) {
            if (confirm(`Apakah Anda yakin ingin melakukan absen ${jenis === 'APEL_PAGI' ? 'PAGI' : 'SORE'} secara manual?`)) {
                processQRScan(jenis);
            }
        }
        
        // Logout
        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar dari sistem?')) {
                if (scanner) {
                    scanner.stop().catch(() => {});
                    scanner = null;
                }
                
                currentUser = null;
                currentDeviceId = null;
                todayAbsensi = { pagi: null, sore: null };
                
                localStorage.removeItem('absensi_user');
                localStorage.removeItem('absensi_device');
                localStorage.removeItem('absensi_last_login');
                
                showLogin();
                showToast('Anda telah logout', 'info');
            }
        }
        
        // Tampilkan loading
        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            if (show) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
            }
        }
        
        // Play beep sound
        function playBeepSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'success') {
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.1);
                } else {
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(300, audioContext.currentTime + 0.1);
                }
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
            } catch (error) {
                console.log('Audio not supported:', error);
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                ">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Handle Enter key in input fields
        function setupEnterKeyHandlers() {
            document.getElementById('nip').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            document.getElementById('reg-nip').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    registerDevice();
                }
            });
        }
        
        // Cek login saat load
        window.onload = function() {
            // Setup enter key handlers
            setupEnterKeyHandlers();
            
            // Update clock setiap detik
            setInterval(updateClock, 1000);
            updateClock();
            
            // Cek session yang tersimpan
            const savedUser = localStorage.getItem('absensi_user');
            const savedDevice = localStorage.getItem('absensi_device');
            const lastLogin = localStorage.getItem('absensi_last_login');
            
            // Cek jika session sudah lama (lebih dari 7 hari)
            let validSession = false;
            if (lastLogin) {
                const lastLoginDate = new Date(lastLogin);
                const now = new Date();
                const diffDays = (now - lastLoginDate) / (1000 * 60 * 60 * 24);
                validSession = diffDays < 7; // Session berlaku 7 hari
            }
            
            if (savedUser && savedDevice && validSession) {
                currentUser = JSON.parse(savedUser);
                currentDeviceId = savedDevice;
                
                // Update info device di footer
                document.getElementById('device-info').textContent = 
                    `Perangkat: ${currentDeviceId.substring(0, 15)}...`;
                
                initQRScanner();
                showScanner();
                showToast('Session dipulihkan', 'info');
                
            } else if (savedUser && savedDevice && !validSession) {
                // Session expired
                localStorage.clear();
                alert('Session telah habis. Silakan login kembali.');
                showLogin();
            } else {
                showLogin();
            }
            
            // Generate device ID jika belum ada
            if (!localStorage.getItem('device_id_pref')) {
                localStorage.setItem('device_id_pref', generateDeviceId());
            }
            
            // Set focus to NIP input
            document.getElementById('nip').focus();
        };
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && scanner && currentUser) {
                // Page became visible again, resume scanner
                setTimeout(() => {
                    if (scanner) {
                        scanner.resume().catch(err => {
                            console.log('Failed to resume scanner:', err);
                        });
                    }
                }, 500);
            }
        });
        
        // Prevent form submission
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
